<html>
<head>
   <title>Box2dWeb example</title>
</head>

<body onload="init();">
   <canvas id="canvas" width="600" height="600"></canvas>
</body>

<script type="text/javascript" src="Box2dWeb-2.1.a.3.min.js"></script>
<script type="text/javascript">
   var world;

   var G = 1;
   var N = 100;

   var bods = [];
   
   function init() {
      var   b2Vec2 = Box2D.Common.Math.b2Vec2
      	,	b2BodyDef = Box2D.Dynamics.b2BodyDef
      	,	b2Body = Box2D.Dynamics.b2Body
      	,	b2FixtureDef = Box2D.Dynamics.b2FixtureDef
      	,	b2Fixture = Box2D.Dynamics.b2Fixture
      	,	b2World = Box2D.Dynamics.b2World
      	,	b2MassData = Box2D.Collision.Shapes.b2MassData
      	,	b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape
      	,	b2CircleShape = Box2D.Collision.Shapes.b2CircleShape
      	,	b2DebugDraw = Box2D.Dynamics.b2DebugDraw
         ;
      
      world = new b2World(
            new b2Vec2(0, 0)    //gravity
         ,  false                 //allow sleep
      );
      
      var fixDef = new b2FixtureDef;
      fixDef.density = 1.0;
      fixDef.friction = 0.5;
      fixDef.restitution = 0.2;
      
      var bodyDef = new b2BodyDef;
      
      //create walls
      bodyDef.type = b2Body.b2_staticBody;
      // Bottom
      bodyDef.position.x = 10;
      bodyDef.position.y = 20;
      fixDef.shape = new b2PolygonShape;
      fixDef.shape.SetAsBox(10, 0.1);
      world.CreateBody(bodyDef).CreateFixture(fixDef);

      // Top
      bodyDef.position.x = 10;
      bodyDef.position.y = 0;
      fixDef.shape = new b2PolygonShape;
      fixDef.shape.SetAsBox(10, 0.1);
      world.CreateBody(bodyDef).CreateFixture(fixDef);

      // Left
      bodyDef.position.x = 0;
      bodyDef.position.y = 10;
      fixDef.shape = new b2PolygonShape;
      fixDef.shape.SetAsBox(0.1, 10);
      world.CreateBody(bodyDef).CreateFixture(fixDef);

      // Right
      bodyDef.position.x = 20;
      bodyDef.position.y = 10;
      fixDef.shape = new b2PolygonShape;
      fixDef.shape.SetAsBox(0.1, 10);
      world.CreateBody(bodyDef).CreateFixture(fixDef);
      
      //create some objects
      bodyDef.type = b2Body.b2_dynamicBody;
      for(var i = 0; i < N; ++i) {
         if(Math.random() > 0.5) {
            fixDef.shape = new b2PolygonShape;
            fixDef.shape.SetAsBox(
                  Math.random()*0.3 + 0.1 //half width
               ,  Math.random()*0.3 + 0.1 //half height
            );
         } else {
            fixDef.shape = new b2CircleShape(
               Math.random()*0.3 + 0.1 //radius
            );
         }
         bodyDef.position.x = 5 + Math.random() * 10;
         bodyDef.position.y = 5 + Math.random() * 10;
         var wb = world.CreateBody(bodyDef).CreateFixture(fixDef);
         var xvel,yvel;
         if (wb.GetBody().GetPosition().x > 10) {
            xvel = (Math.random()-0.5)*4;
            yvel = -Math.random()*2;
         } else {
            xvel = (Math.random()-0.5)*4;
            yvel = Math.random()*2;
         }
         wb.GetBody().SetLinearVelocity({ x: xvel, 
                                          y: yvel    });
         bods.push( wb.GetBody() );
      }
      
      //setup debug draw
      var debugDraw = new b2DebugDraw();
		debugDraw.SetSprite(canvas.getContext("2d"));
		debugDraw.SetDrawScale(30.0);
		debugDraw.SetFillAlpha(0.3);
		debugDraw.SetLineThickness(1.0);
		debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
		world.SetDebugDraw(debugDraw);
      
      window.setInterval(update, 1000 / 60);
   };

   function doForces() {
      for (var i = bods.length - 1; i >= 0; i--) {
         for (var j = i-1; j >= 0; j--) {
            doForce(bods[i],bods[j]);
            //console.log("Force "+i+" <-> "+j);
         };

      };
   }

   function doForce(b1,b2) {
      var x = b1.GetPosition().x;
      var y = b1.GetPosition().y;
      var m = b1.GetMass(); 
      
      var x2 = b2.GetPosition().x;
      var y2 = b2.GetPosition().y;
      var m2 = b2.GetMass();

      var dx = x2-x;
      var dy = y2-y;
      var r2 = dx*dx+dy*dy;
      var r = Math.sqrt(r2);

      var f = G*m*m2/r2
      var fx = dx/r * f;
      var fy = dy/r * f;

      var fvec1 = {x: fx, y: fy};
      var fvec2 = {x: -fx, y: -fy};

      b1.ApplyForce(fvec1, b1.GetPosition() );
      b2.ApplyForce(fvec2, b2.GetPosition() );
   }

   function testForce(i,x,y) {
      var b = bods[i];
      var fv = {x:x,y:y};
      b.ApplyForce( fv , b.GetPosition() );
   }
   
   function update() {
      doForces();
      world.Step(
            1 / 60   //frame-rate
         ,  10       //velocity iterations
         ,  10       //position iterations
      );
      world.DrawDebugData();
      world.ClearForces();
   };

</script>
</html>